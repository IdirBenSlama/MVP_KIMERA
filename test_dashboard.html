<!DOCTYPE html>
<html>
<head>
    <title>KIMERA SWM Dashboard Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric { display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; }
        .value { font-weight: bold; color: #007bff; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üß† KIMERA SWM Dashboard</h1>
    
    <div class="card">
        <h2>Connection Test</h2>
        <div id="connectionStatus">Testing connection...</div>
        <button onclick="testConnection()">Test API Connection</button>
    </div>

    <div class="card">
        <h2>System Metrics</h2>
        <div id="systemMetrics">Click refresh to load metrics</div>
        <button onclick="loadMetrics()">üîÑ Refresh Metrics</button>
        <button onclick="runCycle()">‚ö° Run Cycle</button>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <button onclick="createTestGeoid()">‚ûï Create Test Geoid</button>
        <button onclick="searchGeoids()">üîç Search Geoids</button>
        <div id="actionResults"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8001';

        async function testConnection() {
            const status = document.getElementById('connectionStatus');
            status.innerHTML = 'Testing...';
            
            try {
                const response = await fetch(`${API_URL}/system/status`);
                const data = await response.json();
                status.innerHTML = `<div class="success">‚úÖ Connected! API is responding on port 8001</div>`;
                console.log('API Response:', data);
            } catch (error) {
                status.innerHTML = `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
                console.error('Connection error:', error);
            }
        }

        async function loadMetrics() {
            const container = document.getElementById('systemMetrics');
            container.innerHTML = 'Loading...';
            
            try {
                // Load system status
                const statusResponse = await fetch(`${API_URL}/system/status`);
                const statusData = await statusResponse.json();
                
                // Load stability metrics
                let stabilityData = {};
                try {
                    const stabilityResponse = await fetch(`${API_URL}/system/stability`);
                    stabilityData = await stabilityResponse.json();
                } catch (e) {
                    console.warn('Stability metrics not available:', e);
                }
                
                container.innerHTML = `
                    <div class="metric">
                        <span>Active Geoids:</span>
                        <span class="value">${statusData.active_geoids || 0}</span>
                    </div>
                    <div class="metric">
                        <span>Vault A Scars:</span>
                        <span class="value">${statusData.vault_a_scars || 0}</span>
                    </div>
                    <div class="metric">
                        <span>Vault B Scars:</span>
                        <span class="value">${statusData.vault_b_scars || 0}</span>
                    </div>
                    <div class="metric">
                        <span>System Entropy:</span>
                        <span class="value">${(statusData.system_entropy || 0).toFixed(3)}</span>
                    </div>
                    <div class="metric">
                        <span>Cycle Count:</span>
                        <span class="value">${statusData.cycle_count || 0}</span>
                    </div>
                    ${stabilityData.vault_pressure !== undefined ? `
                    <div class="metric">
                        <span>Vault Pressure:</span>
                        <span class="value">${stabilityData.vault_pressure.toFixed(3)}</span>
                    </div>
                    <div class="metric">
                        <span>Semantic Cohesion:</span>
                        <span class="value">${stabilityData.semantic_cohesion.toFixed(3)}</span>
                    </div>` : ''}
                `;
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Failed to load metrics: ${error.message}</div>`;
            }
        }

        async function runCycle() {
            try {
                const response = await fetch(`${API_URL}/system/cycle`, { method: 'POST' });
                const data = await response.json();
                alert(`‚úÖ Cycle completed!\nContradictions: ${data.contradictions_detected || 0}\nScars: ${data.scars_created || 0}`);
                loadMetrics(); // Refresh metrics
            } catch (error) {
                alert(`‚ùå Cycle failed: ${error.message}`);
            }
        }

        async function createTestGeoid() {
            const results = document.getElementById('actionResults');
            results.innerHTML = 'Creating test geoid...';
            
            try {
                const response = await fetch(`${API_URL}/geoids`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        semantic_features: {
                            "test": 0.8,
                            "example": 0.6,
                            "demo": 0.9
                        },
                        symbolic_content: { "type": "test_geoid" },
                        metadata: { "created_by": "dashboard" }
                    })
                });
                const data = await response.json();
                results.innerHTML = `<div class="success">‚úÖ Created geoid: ${data.geoid_id}</div>`;
                loadMetrics(); // Refresh metrics
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Failed to create geoid: ${error.message}</div>`;
            }
        }

        async function searchGeoids() {
            const results = document.getElementById('actionResults');
            results.innerHTML = 'Searching geoids...';
            
            try {
                const response = await fetch(`${API_URL}/geoids/search?query=test&limit=5`);
                const data = await response.json();
                
                if (data.similar_geoids && data.similar_geoids.length > 0) {
                    results.innerHTML = `
                        <div class="success">‚úÖ Found ${data.similar_geoids.length} geoids:</div>
                        ${data.similar_geoids.map(g => `
                            <div class="metric">
                                <span>${g.geoid_id}</span>
                                <span>${JSON.stringify(g.symbolic_state)}</span>
                            </div>
                        `).join('')}
                    `;
                } else {
                    results.innerHTML = '<div class="success">‚úÖ No geoids found</div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Search failed: ${error.message}</div>`;
            }
        }

        // Auto-load metrics on page load
        window.onload = function() {
            testConnection();
            loadMetrics();
        };

        // Auto-refresh every 10 seconds
        setInterval(loadMetrics, 10000);
    </script>
</body>
</html>